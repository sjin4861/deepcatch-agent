<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>WebSocket Test Demo</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				background-color: #f8f6f3; /* dawn-mist */
				color: #5a6b5d; /* ocean-deep text */
				line-height: 1.6;
				padding: 20px;
			}

			.container {
				max-width: 800px;
				margin: 0 auto;
				background-color: white;
				border-radius: 12px;
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
				overflow: hidden;
			}

			.header {
				background-color: #4a6741; /* ocean-deep */
				color: white;
				padding: 20px;
				text-align: center;
			}

			.content {
				padding: 30px;
			}

			.connection-section {
				background-color: #f8f6f3; /* dawn-mist */
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
			}

			.input-group {
				margin-bottom: 15px;
			}

			label {
				display: block;
				margin-bottom: 5px;
				font-weight: 600;
				color: #756b5e; /* weathered-wood text */
			}

			input,
			textarea {
				width: 100%;
				padding: 12px;
				border: 2px solid #a8b8aa; /* sea-foam */
				border-radius: 6px;
				font-size: 14px;
				transition: border-color 0.3s;
			}

			input:focus,
			textarea:focus {
				outline: none;
				border-color: #4a6741; /* ocean-deep */
			}

			.button-group {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
				flex-wrap: wrap;
			}

			button {
				padding: 12px 24px;
				border: none;
				border-radius: 6px;
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: background-color 0.3s;
			}

			.btn-connect {
				background-color: #a8b8aa; /* sea-foam */
				color: white;
			}

			.btn-connect:hover {
				background-color: #6b7b6e; /* fishing-net */
			}

			.btn-disconnect {
				background-color: #d4a574; /* sunrise-glow */
				color: white;
			}

			.btn-disconnect:hover {
				background-color: #9a8a7b; /* harbor-stone */
			}

			.btn-send {
				background-color: #4a6741; /* ocean-deep */
				color: white;
			}

			.btn-send:hover {
				background-color: #5a6b5d; /* ocean-deep text */
			}

			.btn-clear {
				background-color: #8a7a6b; /* weathered-wood */
				color: white;
			}

			.btn-clear:hover {
				background-color: #756b5e; /* weathered-wood text */
			}

			.btn-record {
				background-color: #6b7b6e; /* fishing-net */
				color: white;
			}

			.btn-record:hover {
				background-color: #5f6f62; /* fishing-net text */
			}

			.btn-record.recording {
				background-color: #d4a574; /* sunrise-glow */
				animation: pulse 1.5s infinite;
			}

			.btn-live-stt {
				background-color: #9a8a7b; /* harbor-stone */
				color: white;
			}

			.btn-live-stt:hover {
				background-color: #8a7a6b; /* weathered-wood */
			}

			.btn-live-stt.active {
				background-color: #d4a574; /* sunrise-glow */
				animation: pulse 1.5s infinite;
			}

			@keyframes pulse {
				0% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
				100% {
					opacity: 1;
				}
			}

			.twilio-section {
				background-color: #f8f6f3; /* dawn-mist */
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
			}

			.audio-section {
				background-color: #f8f6f3; /* dawn-mist */
				padding: 15px;
				border-radius: 8px;
				margin-top: 15px;
			}

			.audio-status {
				padding: 8px 12px;
				border-radius: 4px;
				font-size: 13px;
				margin-top: 10px;
				background-color: #a8b8aa; /* sea-foam */
				color: white;
				text-align: center;
			}

			.call-status {
				padding: 10px 15px;
				border-radius: 6px;
				font-size: 14px;
				margin-top: 15px;
				background-color: #6b7b6e; /* fishing-net */
				color: white;
				text-align: center;
				font-weight: 600;
			}

			.call-status.calling {
				background-color: #d4a574; /* sunrise-glow */
				animation: pulse 1.5s infinite;
			}

			.call-status.connected {
				background-color: #a8b8aa; /* sea-foam */
			}

			.call-status.disconnected {
				background-color: #8a7a6b; /* weathered-wood */
			}

			.btn-call {
				background-color: #a8b8aa; /* sea-foam */
				color: white;
			}

			.btn-call:hover {
				background-color: #6b7b6e; /* fishing-net */
			}

			.btn-call:disabled {
				background-color: #9a8a7b; /* harbor-stone */
				cursor: not-allowed;
			}

			.btn-hangup {
				background-color: #d4a574; /* sunrise-glow */
				color: white;
			}

			.btn-hangup:hover {
				background-color: #9a8a7b; /* harbor-stone */
			}

			.btn-hangup:disabled {
				background-color: #8a7a6b; /* weathered-wood */
				cursor: not-allowed;
			}

			.status {
				padding: 10px;
				border-radius: 6px;
				margin-bottom: 20px;
				font-weight: 600;
			}

			.status.connected {
				background-color: #a8b8aa; /* sea-foam */
				color: white;
			}

			.status.disconnected {
				background-color: #d4a574; /* sunrise-glow */
				color: white;
			}

			.status.error {
				background-color: #d4a574; /* sunrise-glow */
				color: white;
			}

			.messages-section {
				background-color: #f8f6f3; /* dawn-mist */
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
			}

			.messages {
				height: 300px;
				overflow-y: auto;
				border: 2px solid #a8b8aa; /* sea-foam */
				border-radius: 6px;
				padding: 15px;
				background-color: white;
				font-family: "Courier New", monospace;
				font-size: 13px;
			}

			.message {
				margin-bottom: 8px;
				padding: 8px;
				border-radius: 4px;
			}

			.message.sent {
				background-color: #d4c4a8; /* warm-sand */
				text-align: right;
			}

			.message.received {
				background-color: #a8b8aa; /* sea-foam */
				color: white;
			}

			.message.stt {
				background-color: #e0e8e3; /* A lighter, neutral green */
				color: #333;
			}

			.message.system {
				background-color: #f8f6f3; /* dawn-mist */
				font-style: italic;
				color: #756b5e; /* weathered-wood text */
			}

			.timestamp {
				font-size: 11px;
				opacity: 0.7;
			}
		</style>
		<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>ğŸŒŠ WebSocket Test Demo</h1>
				<p>ì‹¤ì‹œê°„ ì—°ê²° í…ŒìŠ¤íŠ¸ í˜ì´ì§€</p>
			</div>

			<div class="content">
				<div class="connection-section">
					<h3>ì—°ê²° ì„¤ì •</h3>
					<div class="input-group">
						<label for="socketUrl">Socket.IO URL:</label>
						<input
							type="text"
							id="socketUrl"
							value="http://localhost:8000"
							placeholder="http://localhost:8000"
						/>
					</div>

					<div class="button-group">
						<button class="btn-connect" onclick="connect()">
							ì—°ê²°
						</button>
						<button class="btn-disconnect" onclick="disconnect()">
							ì—°ê²° í•´ì œ
						</button>
					</div>

					<div id="status" class="status disconnected">ì—°ê²° ëŠê¹€</div>
				</div>

				<div class="twilio-section">
					<h3>ğŸ“ Twilio ì „í™” í†µí™”</h3>

					<div class="input-group">
						<label for="phoneNumber">ì „í™”ë²ˆí˜¸ (E.164 í˜•ì‹):</label>
						<input
							type="text"
							id="phoneNumber"
							placeholder="+821021139911"
							value="+821021139911"
						/>
					</div>

					<div class="button-group">
						<button
							id="callBtn"
							class="btn-call"
							onclick="initiateCall()"
						>
							ğŸ“ ì „í™” ê±¸ê¸°
						</button>
						<button
							id="hangupBtn"
							class="btn-hangup"
							onclick="hangupCall()"
						>
							ğŸ“´ ì „í™” ëŠê¸°
						</button>
					</div>

					<div id="callStatus" class="call-status">ğŸ“ ëŒ€ê¸° ì¤‘</div>
				</div>

				<div class="messages-section">
					<h3>ğŸ“ ì‹¤ì‹œê°„ ëŒ€í™”</h3>
					<div id="messages" class="messages"></div>

					<div class="input-group">
						<label for="messageInput"
							>ë©”ì‹œì§€ ì…ë ¥ (ì°¸ê³ : ì´ ê¸°ëŠ¥ì€ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´
							ìˆìŠµë‹ˆë‹¤):</label
						>
						<textarea
							id="messageInput"
							rows="3"
							placeholder="ì „ì†¡í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
							disabled
						></textarea>
					</div>

					<div class="button-group">
						<button
							class="btn-send"
							onclick="sendMessage()"
							disabled
						>
							ì „ì†¡
						</button>
						<button
							id="recordBtn"
							class="btn-record"
							onclick="toggleRecording()"
							disabled
						>
							ğŸ¤ ë…¹ìŒ ì‹œì‘
						</button>
						<button
							id="liveSTTBtn"
							class="btn-live-stt"
							onclick="toggleLiveSTT()"
							disabled
						>
							ğŸ™ï¸ ì‹¤ì‹œê°„ STT
						</button>
						<button class="btn-clear" onclick="clearMessages()">
							ë©”ì‹œì§€ ì§€ìš°ê¸°
						</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			let socket = null
			let callSid = null
			const statusDiv = document.getElementById("status")
			const messagesDiv = document.getElementById("messages")
			const messageInput = document.getElementById("messageInput")
			const socketUrlInput = document.getElementById("socketUrl")
			const phoneNumberInput = document.getElementById("phoneNumber")
			const callStatusDiv = document.getElementById("callStatus")
			const callBtn = document.getElementById("callBtn")
			const hangupBtn = document.getElementById("hangupBtn")

			function connect() {
				const url = socketUrlInput.value.trim()
				if (!url) {
					addMessage("URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "system")
					return
				}

				if (socket) {
					addMessage("ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.", "system")
					return
				}

				try {
					socket = io(url, {
						transports: ["websocket", "polling"],
					})

					socket.on("connect", () => {
						updateStatus("ì—°ê²°ë¨", "connected")
						addMessage(
							`Socket.IO ì—°ê²° ì„±ê³µ (ID: ${socket.id})`,
							"system"
						)
					})

					socket.on("disconnect", (reason) => {
						updateStatus("ì—°ê²° ëŠê¹€", "disconnected")
						addMessage(
							`ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ìœ : ${reason})`,
							"system"
						)
						socket = null
						resetCallState()
					})

					socket.on("connect_error", (error) => {
						updateStatus("ì—°ê²° ì˜¤ë¥˜", "error")
						addMessage(`ì—°ê²° ì˜¤ë¥˜: ${error.message}`, "system")
						socket = null
					})

					// --- ì‹ ê·œ ë°±ì—”ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

					// í†µí™” ì¢…ë£Œ ì²˜ë¦¬
					socket.on("call_ended", (data) => {
						addMessage(`í†µí™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (SID: ${data.call_sid})`, "system")
						resetCallState()
					})

					// Twilio <Gather>ë¡œ ì¸ì‹ëœ ì‚¬ìš©ì ë°œí™” í‘œì‹œ
					socket.on("user_speech", (data) => {
						addMessage(`[ì‚¬ìš©ì] ${data.text}`, "stt")
					})

					// AI ì‘ë‹µ í‘œì‹œ
					socket.on("ai_response", (data) => {
						addMessage(`[AI] ${data.text}`, "received")
					})
				} catch (error) {
					updateStatus("ì—°ê²° ì˜¤ë¥˜", "error")
					addMessage(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`, "system")
				}
			}

			function disconnect() {
				if (socket) {
					socket.disconnect()
				}
				resetCallState()
			}

			function handleTranscriptionUpdate(text, isFinal) {
				const prefix = "[STT]"
				let tempMsg = document.getElementById("temp-stt")

				if (isFinal) {
					const finalHtml = `<div>${prefix} ${text}</div><div class="timestamp">${new Date().toLocaleTimeString()}</div>`
					if (tempMsg) {
						tempMsg.innerHTML = finalHtml
						tempMsg.id = ""
					} else {
						addMessage(finalHtml, "stt", false)
					}
				} else {
					if (!tempMsg) {
						const messageDiv = document.createElement("div")
						messageDiv.className = "message stt"
						messageDiv.id = "temp-stt"
						messagesDiv.appendChild(messageDiv)
						tempMsg = messageDiv
					}
					tempMsg.innerHTML = `<div>${prefix} ${text}...</div><div class="timestamp">${new Date().toLocaleTimeString()}</div>`
					messagesDiv.scrollTop = messagesDiv.scrollHeight
				}
			}

			function clearMessages() {
				messagesDiv.innerHTML = ""
			}

			function updateStatus(text, className) {
				statusDiv.textContent = text
				statusDiv.className = `status ${className}`
			}

			function updateCallStatus(text, status) {
				callStatusDiv.textContent = text
				callStatusDiv.className = `call-status ${status}`
			}

			function addMessage(text, type, useDiv = true) {
				const messageDiv = document.createElement("div")
				messageDiv.className = `message ${type}`

				if (useDiv) {
					const timestamp = new Date().toLocaleTimeString()
					messageDiv.innerHTML = `
                    <div>${text}</div>
                    <div class="timestamp">${timestamp}</div>
                `
				} else {
					messageDiv.innerHTML = text
				}

				messagesDiv.appendChild(messageDiv)
				messagesDiv.scrollTop = messagesDiv.scrollHeight
			}

			function resetCallState() {
				callBtn.disabled = false
				hangupBtn.disabled = true
				callSid = null
				updateCallStatus("ğŸ“ ëŒ€ê¸° ì¤‘", "")
			}

			window.onload = () => {
				addMessage(
					'Socket.IO í…ŒìŠ¤íŠ¸ ë°ëª¨ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! "ì—°ê²°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„œë²„ì™€ ì—°ê²°í•˜ì„¸ìš”.',
					"system"
				)
				addMessage(
					"ì„œë²„ ì—°ê²° í›„, ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  ğŸ“ ë²„íŠ¼ì„ ëˆŒëŸ¬ í†µí™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
					"system"
				)
				resetCallState()
			}

			async function initiateCall() {
				const phoneNumber = phoneNumberInput.value.trim()
				if (!phoneNumber) {
					addMessage("ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "system")
					return
				}

				if (!socket || !socket.connected) {
					addMessage("ë¨¼ì € Socket.IO ì„œë²„ì— ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.", "system")
					return
				}

				callBtn.disabled = true
				hangupBtn.disabled = false
				updateCallStatus("ğŸ¤™ ì „í™” ê±°ëŠ” ì¤‘...", "calling")

				try {
					const serverUrl = new URL(socketUrlInput.value)
					const apiUrl = `${serverUrl.origin}/call/initiate`

					const response = await fetch(apiUrl, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ to_number: phoneNumber }),
					})

					if (!response.ok) {
						let errorMessage = "ì „í™” ê±¸ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
						try {
							const errorData = await response.json();
							errorMessage = errorData.detail || JSON.stringify(errorData);
						} catch (e) {
							errorMessage = await response.text();
						}
						throw new Error(errorMessage);
					}

					const data = await response.json()
					callSid = data.call_sid
					addMessage(`ì „í™” ì—°ê²° ì‹œì‘ (SID: ${callSid})`, "system")
					updateCallStatus("ğŸ”” í†µí™” ì—°ê²°ë¨", "connected")
				} catch (error) {
					addMessage(`ì˜¤ë¥˜: ${error.message}`, "system")
					resetCallState()
				}
			}

			function hangupCall() {
				addMessage("ì‚¬ìš©ìê°€ ì§ì ‘ ì „í™”ë¥¼ ëŠìœ¼ë©´ ìë™ìœ¼ë¡œ ê°ì§€ë©ë‹ˆë‹¤.", "system")
			}

			// ì•„ë˜ í•¨ìˆ˜ë“¤ì€ í˜„ì¬ ë°±ì—”ë“œì™€ í˜¸í™˜ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
			function sendMessage() {
				console.warn("sendMessage ê¸°ëŠ¥ì€ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
			}
			function toggleRecording() {
				console.warn("toggleRecording ê¸°ëŠ¥ì€ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
			}
			function toggleLiveSTT() {
				console.warn("toggleLiveSTT ê¸°ëŠ¥ì€ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
			}
		</script>
	</body>
</html>
